<!-- App Container -->
<div class="app-container" [class.sidebar-collapsed]="isCollapsed$ | async">
  
  <!-- Skip Link para Accesibilidad -->
  <a class="skip-link" href="#main-content" tabindex="0">
    Ir al contenido principal
  </a>

  <!-- Header Principal (Solo si está autenticado) -->
  <header class="app-header" role="banner" *ngIf="isAuthenticated">
    <div class="header-content">
      
      <!-- Sección Izquierda: Logo y Toggle -->
      <div class="header-left">
        <button 
          class="sidebar-toggle"
          type="button"
          [attr.aria-label]="(isCollapsed$ | async) ? 'Expandir menú lateral' : 'Contraer menú lateral'"
          [matTooltip]="(isCollapsed$ | async) ? 'Expandir menú' : 'Contraer menú'"
          matTooltipPosition="below"
          (click)="toggleSidebar()">
          <mat-icon>menu</mat-icon>
        </button>
        
        <div class="logo-container">
          <svg class="logo" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="32" height="32" rx="8" fill="url(#logo-gradient)"/>
            <path d="M16 8L8 12V20L16 24L24 20V12L16 8Z" fill="white" opacity="0.9"/>
            <path d="M16 12L12 14V18L16 20L20 18V14L16 12Z" fill="white"/>
            <defs>
              <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                <stop stop-color="#667eea"/>
                <stop offset="1" stop-color="#764ba2"/>
              </linearGradient>
            </defs>
          </svg>
          <span class="logo-text" *ngIf="(isHandset$ | async) === false">
            {{ title }}
          </span>
        </div>
      </div>

      <!-- Breadcrumbs (Solo en desktop) -->
      <nav 
        class="breadcrumbs" 
        aria-label="Navegación de ruta" 
        *ngIf="(isHandset$ | async) === false && breadcrumbs.length > 0">
        <ol class="breadcrumb-list">
          <li class="breadcrumb-item" *ngFor="let crumb of breadcrumbs; let last = last">
            <a
              *ngIf="!last && crumb.route"
              [routerLink]="crumb.route"
              class="breadcrumb-link"
              [attr.aria-label]="'Navegar a ' + crumb.label">
              {{ crumb.label }}
            </a>
            <span *ngIf="last || !crumb.route" class="breadcrumb-current" [attr.aria-current]="last ? 'page' : null">
              {{ crumb.label }}
            </span>
            <mat-icon *ngIf="!last" class="breadcrumb-separator" aria-hidden="true">
              chevron_right
            </mat-icon>
          </li>
        </ol>
      </nav>

      <!-- Sección Derecha: Búsqueda, Notificaciones y Perfil -->
      <div class="header-right">
        
        <!-- Búsqueda Rápida (Solo en desktop) -->
        <div class="quick-search" *ngIf="(isHandset$ | async) === false">
          <form (ngSubmit)="performSearch()" class="search-container">
            <mat-icon class="search-icon" aria-hidden="true">search</mat-icon>
            <input
              type="search"
              placeholder="Buscar productos, categorías..."
              class="search-input"
              [(ngModel)]="searchQuery"
              name="search"
              [attr.aria-label]="'Buscar en inventario'">
          </form>
        </div>

        <!-- Botón de Notificaciones -->
        <button 
          class="header-action"
          type="button"
          mat-icon-button
          [matMenuTriggerFor]="notificationsMenu"
          [matBadge]="notificationCount"
          [matBadgeHidden]="notificationCount === 0"
          matBadgeColor="warn"
          matBadgeSize="small"
          [matTooltip]="'Notificaciones (' + notificationCount + ')'"
          matTooltipPosition="below"
          aria-label="Ver notificaciones">
          <mat-icon>notifications</mat-icon>
        </button>

        <!-- Menu de Notificaciones -->
        <mat-menu #notificationsMenu="matMenu" class="notifications-menu" xPosition="before">
          <div class="notifications-header" (click)="$event.stopPropagation()">
            <h3>Notificaciones</h3>
            <button 
              mat-icon-button 
              class="clear-all" 
              (click)="clearAllNotifications()"
              [disabled]="notifications.length === 0"
              [matTooltip]="'Limpiar todas'"
              matTooltipPosition="below"
              aria-label="Limpiar todas las notificaciones">
              <mat-icon>clear_all</mat-icon>
            </button>
          </div>
          <mat-divider></mat-divider>
          
          <!-- Lista de Notificaciones -->
          <div *ngIf="notifications.length > 0" style="max-height: 400px; overflow-y: auto;">
            <div 
              class="notification-item" 
              *ngFor="let notification of notifications"
              (click)="$event.stopPropagation()">
              <mat-icon 
                [class]="'notification-icon ' + notification.type"
                [attr.aria-label]="notification.type">
                {{ getNotificationIcon(notification.type) }}
              </mat-icon>
              <div class="notification-content">
                <p class="notification-text">{{ notification.message }}</p>
                <time class="notification-time" [attr.datetime]="notification.time.toISOString()">
                  {{ notification.time | date:'short' }}
                </time>
              </div>
            </div>
          </div>
          
          <!-- Estado Vacío -->
          <div class="no-notifications" *ngIf="notifications.length === 0">
            <mat-icon aria-hidden="true">notifications_none</mat-icon>
            <p>No tienes notificaciones nuevas</p>
          </div>
        </mat-menu>

        <!-- Perfil de Usuario -->
        <button 
          class="user-profile"
          type="button"
          [matMenuTriggerFor]="userMenu"
          [matTooltip]="currentUser?.username || 'Menú de usuario'"
          matTooltipPosition="below"
          aria-label="Menú de usuario">
          
          <div class="user-avatar">
            <img 
              *ngIf="currentUser?.avatar" 
              [src]="currentUser.avatar" 
              [alt]="'Avatar de ' + currentUser.username"
              class="avatar-image"
              loading="lazy">
            <mat-icon *ngIf="!currentUser?.avatar" class="avatar-icon" aria-hidden="true">
              person
            </mat-icon>
          </div>
          
          <span class="user-name" *ngIf="(isHandset$ | async) === false">
            {{ currentUser?.username || 'Usuario' }}
          </span>
          
          <mat-icon class="dropdown-icon" aria-hidden="true">
            keyboard_arrow_down
          </mat-icon>
        </button>

        <!-- Menu de Usuario -->
        <mat-menu #userMenu="matMenu" class="user-menu" xPosition="before">
          <div class="user-info" (click)="$event.stopPropagation()">
            <div class="user-avatar-large">
              <img 
                *ngIf="currentUser?.avatar" 
                [src]="currentUser.avatar" 
                [alt]="'Avatar de ' + currentUser.username"
                class="avatar-image"
                loading="lazy">
              <mat-icon *ngIf="!currentUser?.avatar" class="avatar-icon" aria-hidden="true">
                person
              </mat-icon>
            </div>
            <div class="user-details">
              <h4 class="user-name-menu">{{ currentUser?.username || 'Usuario' }}</h4>
              <p class="user-email">{{ currentUser?.email || 'usuario&#64;inventario.com' }}</p>
            </div>
          </div>
          <mat-divider></mat-divider>
          
          <button mat-menu-item class="menu-item" (click)="navigateToProfile()">
            <mat-icon>person</mat-icon>
            <span>Mi Perfil</span>
          </button>
          
          <button mat-menu-item class="menu-item" (click)="navigateToSettings()">
            <mat-icon>settings</mat-icon>
            <span>Configuración</span>
          </button>
          
          <button mat-menu-item class="menu-item" (click)="toggleTheme()">
            <mat-icon>{{ isDarkTheme ? 'light_mode' : 'dark_mode' }}</mat-icon>
            <span>{{ isDarkTheme ? 'Tema Claro' : 'Tema Oscuro' }}</span>
          </button>
          
          <mat-divider></mat-divider>
          
          <button mat-menu-item class="menu-item logout-item" (click)="logout()">
            <mat-icon>logout</mat-icon>
            <span>Cerrar Sesión</span>
          </button>
        </mat-menu>
      </div>
    </div>
  </header>

  <!-- Contenedor con Sidebar (Solo si está autenticado) -->
  <mat-sidenav-container class="sidenav-container" *ngIf="isAuthenticated">
    
    <!-- Sidebar -->
    <mat-sidenav 
      #sidenav
      class="app-sidenav"
      [mode]="(isHandset$ | async) ? 'over' : 'side'"
      [opened]="!(isHandset$ | async)"
      [fixedInViewport]="isHandset$ | async"
      [fixedTopGap]="64"
      [attr.aria-label]="'Menú de navegación principal'">
      
      <nav class="sidebar-nav" role="navigation" aria-label="Menú principal">
        <ul class="nav-list" role="menu">
          <li class="nav-item" *ngFor="let item of menuItems" role="none">
            <a
              class="nav-link"
              role="menuitem"
              [routerLink]="item.route"
              routerLinkActive="active"
              [matTooltip]="(isHandset$ | async) ? '' : item.label"
              matTooltipPosition="right"
              [attr.aria-label]="item.label">
              
              <mat-icon class="nav-icon" aria-hidden="true">{{ item.icon }}</mat-icon>
              <span class="nav-label">{{ item.label }}</span>
              <span 
                class="nav-badge" 
                *ngIf="item.badge"
                [attr.aria-label]="item.badge + ' elementos'">
                {{ item.badge }}
              </span>
            </a>
          </li>
        </ul>
      </nav>
    </mat-sidenav>

    <!-- Contenido Principal -->
    <mat-sidenav-content class="main-content" role="main" id="main-content">
      <div class="content-wrapper">
        <router-outlet></router-outlet>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>

  <!-- Contenedor de Autenticación (cuando no está autenticado) -->
  <div *ngIf="!isAuthenticated" class="auth-container">
    <router-outlet></router-outlet>
  </div>

  <!-- Overlay para móvil cuando el sidebar está abierto -->
  <div
    class="sidenav-overlay"
    *ngIf="(isHandset$ | async) && sidenav?.opened"
    (click)="sidenav.close()"
    role="presentation"
    aria-hidden="true">
  </div>
</div>